---
import { getCollection, render } from 'astro:content';
import ModuleLayout from '../../layouts/ModuleLayout.astro';
import QuestionHeader from '../../components/module/QuestionHeader.astro';
import CoreExplanation from '../../components/module/CoreExplanation.astro';
import KeyConcepts from '../../components/module/KeyConcepts.astro';
import CodeExample from '../../components/module/CodeExample.astro';
import PitfallsSection from '../../components/module/PitfallsSection.astro';
import CaseStudy from '../../components/module/CaseStudy.astro';
import QuizSection from '../../components/module/QuizSection.astro';
import FurtherReading from '../../components/module/FurtherReading.astro';

export async function getStaticPaths() {
  const modules = await getCollection('modules');
  return modules.map((mod) => ({
    params: { slug: mod.data.id },
    props: { module: mod },
  }));
}

const { module } = Astro.props;
const { data } = module;
const { Content } = await render(module);

// Load quiz data for this module
let quizData = null;
const quizFiles = import.meta.glob('../../data/quizzes/*.json', { eager: true });
const quizKey = Object.keys(quizFiles).find(key => key.includes(data.id));
if (quizKey) {
  quizData = (quizFiles[quizKey] as any).default;
}
---

<ModuleLayout
  title={data.title}
  description={data.coreExplanation.summary}
  moduleId={data.id}
  questionNumber={data.questionNumber}
>
  <QuestionHeader
    questionNumber={data.questionNumber}
    question={data.question}
    whatItTests={data.whatItTests}
  />

  <CoreExplanation explanation={data.coreExplanation} />

  <KeyConcepts concepts={data.keyConcepts} />

  {data.codeExamples && data.codeExamples.length > 0 && (
    <section id="code-examples" class="mb-12">
      <h2 class="text-2xl font-bold mb-6">Code Examples</h2>
      {data.codeExamples.map((example) => (
        <CodeExample
          title={example.title}
          language={example.language}
          code={example.code}
          description={example.description}
        />
      ))}
    </section>
  )}

  <PitfallsSection pitfalls={data.pitfalls} />

  <section id="case-studies" class="mb-12">
    <h2 class="text-2xl font-bold mb-6">Real-World Application</h2>
    {data.caseStudies.map((study) => (
      <CaseStudy study={study} />
    ))}
  </section>

  {/* Rendered Markdown body (extended prose) */}
  <section id="extended-content" class="prose prose-gray dark:prose-invert max-w-none mb-12 prose-headings:font-bold prose-h2:text-xl prose-h2:mt-8 prose-h2:mb-3 prose-h3:text-lg prose-h3:mt-6 prose-h3:mb-2 prose-p:leading-relaxed prose-strong:text-gray-900 dark:prose-strong:text-white prose-table:text-sm prose-th:bg-gray-50 dark:prose-th:bg-gray-800 prose-th:px-3 prose-th:py-2 prose-td:px-3 prose-td:py-2 prose-td:border-t prose-td:border-gray-200 dark:prose-td:border-gray-700">
    <Content />
  </section>

  {quizData && (
    <QuizSection quizData={quizData} moduleId={data.id} />
  )}

  <FurtherReading links={data.furtherReading} />
</ModuleLayout>
